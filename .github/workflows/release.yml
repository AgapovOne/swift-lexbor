name: Release

on:
  push:
    tags:
      - "[0-9]+.[0-9]+.[0-9]+"

jobs:
  validate:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - uses: swift-actions/setup-swift@v2
        with:
          swift-version: "6.2"
      - name: Build
        run: swift build
      - name: Test
        run: swift test

  release:
    needs: validate
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - name: Extract changelog for this version
        id: changelog
        run: |
          version="${GITHUB_REF_NAME}"
          # Extract section between this version header and the next version header (or EOF)
          changelog=$(awk "/^## \\[${version}\\]/{found=1; next} /^## \\[/{found=0} found" CHANGELOG.md)
          # Write to GitHub output using delimiter
          {
            echo "body<<CHANGELOG_EOF"
            echo "$changelog"
            echo "CHANGELOG_EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.body }}
          generate_release_notes: false
